<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clube de Pontos - Novo Horizonte</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <style>
    body {
      min-height: 100vh;
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      background: linear-gradient(120deg, #e2f6ef 0%, #fff 50%, #ffe5e6 100%);
      position: relative;
      overflow-x: hidden;
    }
    .bg-promo { /* SVG de fundo, igual ao original */ ... }
    /* ... Demais estilos idênticos ao seu, não copio aqui para não poluir a resposta */
    .btn-disponivel {
      background: #e6f4ea;
      color: #198754;
      font-weight: 600;
      border: 1.5px solid #20c997;
      border-radius: 1.5rem;
      padding: 0.6rem 1.2rem;
      min-width: 180px;
      opacity: 1;
    }
    .btn-disponivel[disabled] {
      opacity: 1;
    }
    /* Coloque os estilos anteriores aqui como estavam */
  </style>
</head>
<body>
  <!-- SVG de fundo igual ao original -->
  <svg class="bg-promo" width="100vw" height="100vh"> ... </svg>
  <div id="loginBox" class="cliente-card"> ... <!-- igual ao original --> </div>
  <div id="clienteBox" style="display:none">
    <div class="cliente-card"> ... <!-- igual ao original, só mudando saldo --> </div>
    <div class="catalogo-card">
      <h4 style="text-align:center; color:#e21a35;font-weight:700;margin-bottom:1.5rem;letter-spacing:-1px;">
        Produtos para resgatar neste mês <i class="fa-solid fa-gift"></i>
      </h4>
      <div id="produtosCatalogo"></div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = { /* ...mesma config... */ };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let clienteLogado = null;
    let clienteId = null;

    document.getElementById("entrarBtn").onclick = async () => {
      const tel = document.getElementById("telefone").value.trim();
      const senha = document.getElementById("senha").value.trim();
      document.getElementById("loginErro").innerText = "";

      if (!tel || !senha) {
        document.getElementById("loginErro").innerText = "Preencha todos os campos!";
        return;
      }

      const q = query(collection(db, "clientes"), where("telefone", "==", tel), where("senha", "==", senha));
      const snap = await getDocs(q);

      if (snap.empty) {
        document.getElementById("loginErro").innerText = "Telefone ou senha incorretos!";
        return;
      }

      clienteLogado = snap.docs[0].data();
      clienteId = snap.docs[0].id;

      document.getElementById("loginBox").style.display = "none";
      document.getElementById("clienteBox").style.display = "block";
      document.getElementById("clienteNome").innerText = clienteLogado.nome || "-";

      await mostrarSaldo();
      await mostrarCatalogo();
    };

    document.getElementById("sairBtn").onclick = () => {
      document.getElementById("loginBox").style.display = "";
      document.getElementById("clienteBox").style.display = "none";
      document.getElementById("telefone").value = "";
      document.getElementById("senha").value = "";
      document.getElementById("loginErro").innerText = "";
      clienteLogado = null;
      clienteId = null;
      document.getElementById("produtosCatalogo").innerHTML = "";
      document.getElementById("clienteSaldo").innerText = "...";
      document.getElementById("clienteNome").innerText = "";
    };

    async function mostrarSaldo() {
      // Busca sempre do documento do cliente após login/resgate
      const docSnap = await getDoc(doc(db, "clientes", clienteId));
      let saldo = 0;
      if (docSnap.exists()) {
        const c = docSnap.data();
        saldo = (c.pontos_gerados || 0) - (c.pontos_resgatados || 0);
      }
      document.getElementById("clienteSaldo").innerText = saldo.toLocaleString("pt-BR", {minimumFractionDigits:2});
    }

    async function mostrarCatalogo() {
      const now = new Date();
      const mesAtual = String(now.getMonth() + 1).padStart(2, '0');
      const anoAtual = String(now.getFullYear());

      // Busca produtos da coleção produtos_resgate
      const snapProdutos = await getDocs(collection(db, "produtos_resgate"));
      const produtos = [];
      snapProdutos.forEach(doc => {
        produtos.push({ id: doc.id, ...doc.data() });
      });

      // Busca resgates do cliente no mês
      const snapResgates = await getDocs(query(collection(db, "resgates"), where("clienteId", "==", clienteId)));
      const idsResgatadosEsteMes = new Set();
      snapResgates.forEach(doc => {
        const d = doc.data();
        let dataResgate = null;
        if (d.dataResgateString) {
          const [dia, mes, ano] = d.dataResgateString.split('/');
          dataResgate = { mes, ano };
        } else if (d.dataResgate && d.dataResgate.toDate) {
          const data = d.dataResgate.toDate();
          dataResgate = { mes: String(data.getMonth()+1).padStart(2,'0'), ano: String(data.getFullYear()) };
        }
        if (dataResgate && dataResgate.mes === mesAtual && dataResgate.ano === anoAtual && d.produtoId) {
          idsResgatadosEsteMes.add(String(d.produtoId));
        }
      });

      const div = document.getElementById("produtosCatalogo");
      div.innerHTML = "";
      let encontrou = false;
      produtos.forEach(prod => {
        if (!idsResgatadosEsteMes.has(String(prod.id))) {
          encontrou = true;
          div.innerHTML += `
            <div class="prod-card">
              <div style="display:flex;gap:1.2rem;align-items:center;">
                ${(prod.imagemUrl || prod.imagem) ? `<img src="${prod.imagemUrl || prod.imagem}" style="width:68px;height:68px;object-fit:cover;border-radius:0.8rem;border:2px solid #e21a35;background:#fff;">` : `<div style="width:68px;height:68px;background:#eee;border-radius:0.8rem;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:2rem;"><i class="fa-solid fa-box"></i></div>`}
                <div>
                  <div class="prod-nome">${prod.nome}</div>
                  <div class="prod-desc">${prod.descricao || ""}</div>
                  <div class="prod-pontos"><i class="fa-solid fa-coins"></i> ${prod.pontos} pontos</div>
                </div>
              </div>
              <button class="btn-disponivel" disabled>
                Disponível para resgate
              </button>
              ${(prod.promocao ? `<span class="selo-promo-prod">Promoção</span>` : "")}
            </div>
          `;
        }
      });
      if (!encontrou) {
        div.innerHTML = `<div class="alert alert-info text-center" style="font-weight:600">
          Você já resgatou todos os produtos permitidos este mês.<br>
          Consulte seu extrato ou aguarde o próximo mês para novos resgates!
        </div>`;
      }
    }
  </script>
</body>
</html>
